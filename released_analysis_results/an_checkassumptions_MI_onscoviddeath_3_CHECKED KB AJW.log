----------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-risk-factors-research-full\analysis\output/an_checkassumptions_MI_onscoviddeath_3.log
  log type:  text
 opened on:   7 Jul 2020, 02:59:27

. 
. local k = `region'

. noi di `region'
3

. 
. * Load user written functions
. do Calibration_parameter_nlsolution.do  

. ********************************************************************************
. *
. *       Do-file:                Calibration_parameter_nlsolution.do
. *
. *       Project:                Risk factors for poor outcomes in Covid-19; Ethnicity MNAR
. *
. *       Programmed by:  Fizz
. *
. *       Data used:              None
. *
. *       Data created:   None
. *
. *       Other output:   User-written program:  nlnle2 and a wrapper, nlnle2_wrap
. *
. ********************************************************************************
. *
. *       Purpose:                This do-file creates a program whose purpose is to solve
. *                                       a specific set of non-linear equations.
. *  
. ********************************************************************************
. *       
. *       Input parameters: The following globals need to be defined:
. *
. *               Number missing ethnicity, $Nmis 
. *               Probability of missing/observing ethnicity, $r0star and $r1star
. *               Probability of each ethnicity among observed, $Eth1obsstar, 
. *                                               $Eth2obsstar, $Eth3obsstar, $Eth4obsstar
. *               Marginal probability of ethnicity (external data), $Eth1, $Eth2, $Eth3, $Eth4
. *
. *       Input variables: The following variables need to be in memory:
. *
. *               r - indicator of Ethnicity being observed (1=yes, 0=no)
. *               lp1 - linear predictor from mlogit model to impute ethnicity among r=1, Black
. *               lp2 - linear predictor from mlogit model to impute ethnicity among r=1, Asian
. *               lp3 - linear predictor from mlogit model to impute ethnicity among r=1, Mixed
. *               lp4 - linear predictor from mlogit model to impute ethnicity among r=1, Other
. *
. *
. *       ASSUMPTIONS:    This is a complete case sample, other than ethnicity.
. *                                       Ethnicity is White, Black, Asian, Mixed, other
. *                                       (same order, coding (1, 2, 3, 4, 5), labelling)
. *  
. ********************************************************************************
. 
. 
. ********************************************************************************
. *       
. *       To run alone:   
. *                       matrix mat = (1,0,0,0)
. *                       nlnle2 y lp1 lp2 lp3 lp4 r, at(mat)
. *
. *       Use in MI process:
. *                       nl nle2 @ y lp1 lp2 lp3 lp4 ethnicity, ///
> *                                       parameters(A B C D) initial(A 2 B 2 C 2 D 2)
. *
. ********************************************************************************
. 
. 
. *******************************************
. *  Program to solve non-linear equations  *
. *******************************************
. 
. 
. cap prog drop nlnle2

. program nlnle2
  1. syntax varlist(min=6 max=6) [if], at(name)
  2. 
.         * Pick up inputs
.         tokenize `varlist'
  3.         local y   `1'
  4.         local lp1 `2'
  5.         local lp2 `3'
  6.         local lp3 `4'
  7.         local lp4 `5'
  8.         local r   `6'
  9.         
.         * Pick up current parameter values (Black/Asian/Mixed/Other, respectively)
.         tempname A B C D
 10.         scalar `A' = `at'[1, 1]
 11.         scalar `B' = `at'[1, 2]
 12.         scalar `C' = `at'[1, 3]
 13.         scalar `D' = `at'[1, 4]
 14. 
.         tempvar yh t1 t2 t3 t4 denom
 15.         
.         * Linear predictor among those missing ethnicity
.         gen `denom' = 1 + exp(`A' + `lp1') + exp(`B' + `lp2') + exp(`C' + `lp3') + exp(`D' + `lp4')
 16.         gen `t1' = exp(`A' + `lp1')/`denom'
 17.         gen `t2' = exp(`B' + `lp2')/`denom'
 18.         gen `t3' = exp(`C' + `lp3')/`denom'
 19.         gen `t4' = exp(`D' + `lp4')/`denom'
 20. 
.         qui summ `t1' if `r'==0
 21.         local t1sum=r(sum)
 22.         qui summ `t2' if `r'==0
 23.         local t2sum=r(sum)
 24.         qui summ `t3' if `r'==0
 25.         local t3sum=r(sum)
 26.         qui summ `t4' if `r'==0
 27.         local t4sum=r(sum)
 28.         
.         * Set equal to marginal expression (using external data)
.         gen double      `yh' =  `t1sum'*$r0star/$Nmis + $Eth1obsstar*$r1star - $Eth1 + 1 in 1
 29.         replace         `yh' =  `t2sum'*$r0star/$Nmis + $Eth2obsstar*$r1star - $Eth2 in 2
 30.         replace         `yh' =  `t3sum'*$r0star/$Nmis + $Eth3obsstar*$r1star - $Eth3 in 3
 31.         replace         `yh' =  `t4sum'*$r0star/$Nmis + $Eth4obsstar*$r1star - $Eth4 in 4
 32. 
.         * Return 4 equations evaluated at current versions of parameter 
.         replace `y' = `yh'
 33. 
. end

. 
. 
. 
. 
. 
. *******************************
. *  Wrapper for program above  *
. *******************************
. 
. 
. cap prog drop nlnle2_wrap

. program nlnle2_wrap, rclass
  1. 
.         * Check inputs are there and print summary
. 
.         di _n "INPUTS:" 
  2.         
.         di _n "Missingness of ethnicity:"
  3.         di _col(10) "Number missing ethnicity data:   " $Nmis 
  4.         di _col(10) "Probability of missing  (drawn): " $r0star
  5.         di _col(10) "Probability of observed (drawn): " $r1star
  6. 
. 
.         di _n "Drawn proportions (among complete cases):"
  7.         di _col(10)"Black (drawn): " $Eth1obsstar
  8.         di _col(10)"Asian (drawn): " $Eth2obsstar
  9.         di _col(10)"Mixed (drawn): " $Eth3obsstar
 10.         di _col(10)"Other (drawn): " $Eth4obsstar
 11. 
.         di _n "External data:"
 12.         di _col(10) "Black (external): " $Eth1
 13.         di _col(10) "Asian (external): " $Eth2
 14.         di _col(10) "Mixed (external): " $Eth3
 15.         di _col(10) "Other (external): " $Eth4
 16. 
.         * Check linear predictor variables exist
.         confirm numeric variable lp1
 17.         confirm numeric variable lp2
 18.         confirm numeric variable lp3
 19.         confirm numeric variable lp4
 20.            
. 
.         * Create variable to house estimation results
.         qui gen     y = 1 in 1
 21.         qui replace y = 0 in 2
 22.         qui replace y = 0 in 3
 23.         qui replace y = 0 in 4
 24. 
.         qui nl nle2 @ y lp1 lp2 lp3 lp4 r, ///
>                 parameters(A B C D) initial(A 0 B 0 C 0 D 0)
 25. 
.         qui drop y 
 26. 
.         * Convert calibration parameters into RR for being observed among r=0 vs r=1
.         mat def G = e(b)
 27.         * On logged scale
.         local delta1 = G[1,1]
 28.         local delta2 = G[1,2]
 29.         local delta3 = G[1,3]
 30.         local delta4 = G[1,4]
 31.         * On RR scale
.         local gamma1 = exp(G[1,1])
 32.         local gamma2 = exp(G[1,2])
 33.         local gamma3 = exp(G[1,3])
 34.         local gamma4 = exp(G[1,4])
 35. 
.         
.         /*  Return parameters  */ 
.         
.         return scalar rr1 = `gamma1'
 36.         return scalar rr2 = `gamma2'
 37.         return scalar rr3 = `gamma3'
 38.         return scalar rr4 = `gamma4'
 39.         
.         noi di _n "ESTIMATED CALIBRATION PARAMETERS:  "
 40. 
.         noi di _col(10) "Parameter (log scale):"
 41.         noi di _col(10) "Black:  " `delta1'
 42.         noi di _col(10) "Asian:  " `delta2'
 43.         noi di _col(10) "Mixed:  " `delta3'
 44.         noi di _col(10) "Other:  " `delta4'
 45.         noi di _col(10) "Relative risk (for being this ethnicity (vs white)"
 46.         noi di _col(15) "...in missing cf complete cases):"
 47.         noi di _col(10) "Black:  " `gamma1'
 48.         noi di _col(10) "Asian:  " `gamma2'
 49.         noi di _col(10) "Mixed:  " `gamma3'
 50.         noi di _col(10) "Other:  " `gamma4'
 51.         
. end

. 
. 
. 
end of do-file

. do Calibration_parameter_estimation.do  

. ********************************************************************************
. *
. *       Do-file:                Calibration_parameter_estimation.do
. *
. *       Project:                Risk factors for poor outcomes in Covid-19; Ethnicity MNAR
. *
. *       Programmed by:  Fizz
. *
. *       Data used:              None
. *
. *       Data created:   None
. *
. *       Other output:   User-written programs:  count_missing and prop_ethnicity
. *
. ********************************************************************************
. *
. *       Purpose:                This do-file creates programs which count the proportion 
. *                                       of missing ethnicity data, and the proportion in each group
. *                                       in the complete case data. 
. *
. *                                       It then draws these parameters from their posterior 
. *                                       predictive distributions. 
. *
. *       ASSUMPTIONS:    This is a complete case sample, other than ethnicity.
. *                                       Ethnicity is White, Black, Asian, Mixed, other
. *                                       (same order, coding (1, 2, 3, 4, 5), labelling)
. *  
. ********************************************************************************
. 
. 
. 
. 
. ***************************************************
. *  Observed and drawn proportions of missingness  *
. ***************************************************
. 
. 
. capture program drop count_missing

. program define count_missing, rclass
  1.         syntax varname
  2.         
.         
.         /*      Number of patients with missing ethnicity  */
. 
.         * Overall
.         qui count if `varlist' == 0 
  3.         local Nmis = r(N)
  4.         qui count if `varlist' == 1
  5.         local Nobs = r(N)
  6. 
.         
.         /*  Draw probability of observing ethnicity  */
. 
. 
.         * Sample proportion of observed ethnicity
.         qui count if `varlist' == 0
  7.         local r0 = r(N)/_N
  8.         local se_r0 = sqrt((`r0'*(1-`r0'))/_N)
  9. 
.         ** Draw probability from the normal approximation
.         ** whose mean is the sample proportion of observed ethnicities
.         local r0star = rnormal(`r0', `se_r0')
 10.         local r1star = 1-`r0star'
 11. 
. 
.         /*  Return probabilities  */
.         
.         * Observed proportions
.         return scalar Nmis = `Nmis'
 12.         return scalar Nobs = `Nobs'
 13.         
.         * Drawn probabilities 
.         return scalar r0star = `r0star'
 14.         return scalar r1star = `r1star'
 15. 
.         
.         /*  Display results  */
.         
.         noi di _n "Observed proportions:"
 16.         
.         noi di _col(10) "Number Missing:   " `Nmis'
 17.         noi di _col(10) "Number Observed:  " `Nobs'
 18.         
.         noi di _n "Drawn probabilities:"
 19.         
.         noi di _col(10)  "P(Missing):        " `r0star'
 20.         noi di _col(10)  "P(Observed):       " `r1star'
 21.         
. end

.         
.         
.         
.         
. ***************************************************************
. *  Observed and drawn proportions of each ethnicity category  *
. ***************************************************************
. 
. 
. capture program drop prop_ethnicity

. program define prop_ethnicity, rclass
  1.         syntax varname
  2.         
.         * Check there are 4 categories
.         assert inlist(`varlist', 1, 2, 3, 4, 5, ., .u)
  3.         
.         * Count number of observations
.         qui count if `varlist'<.
  4.         local nobs = r(N)
  5.         
.         /*  Draw probability of each ethnicity category  */ 
. 
.         * Pick up observed proportions of each ethnicity (in complete cases)
.         prop `varlist'  
  6.         mat def Eth_m = r(table)
  7. 
.         ** Draw probability from the normal approximation
.         ** whose mean is the corresponding observed proportion of each category
.         forvalues i = 2 (1) 5 {
  8.             local j = `i' - 1
  9.                 local Eth`j'obs = Eth_m[1,`i']
 10.                 local se_Eth`j'obs = sqrt((`Eth`j'obs'*(1-`Eth`j'obs'))/(`nobs'))
 11.                 local Eth`j'obsstar = rnormal(`Eth`j'obs', `se_Eth`j'obs')
 12.         }
 13.         matrix drop Eth_m
 14.         
. 
.         /*  Return probabilities  */
.         
.         * Observed proportions
.         return scalar Eth1obs = `Eth1obs'
 15.         return scalar Eth2obs = `Eth2obs'
 16.         return scalar Eth3obs = `Eth3obs'
 17.         return scalar Eth4obs = `Eth4obs'
 18.         
.         * Drawn probabilities 
.         return scalar Eth1obsstar = `Eth1obsstar'
 19.         return scalar Eth2obsstar = `Eth2obsstar'
 20.         return scalar Eth3obsstar = `Eth3obsstar'
 21.         return scalar Eth4obsstar = `Eth4obsstar'
 22. 
.         
.         /*  Display results  */
.         
.         noi di _n "Observed proportions of each ethnic group:"
 23.         
.         noi di _col(10) "Proportion Black:   " `Eth1obs'
 24.         noi di _col(10) "Proportion Asian:   " `Eth2obs'
 25.         noi di _col(10) "Proportion Mixed:   " `Eth3obs'
 26.         noi di _col(10) "Proportion Other:   " `Eth4obs'
 27.         
.         noi di _n "Drawn probabilities of each ethnic group:"
 28.         
.         noi di _col(10)  "P(Black | r=1):  " `Eth1obsstar'
 29.         noi di _col(10)  "P(Asian | r=1):  " `Eth2obsstar'
 30.         noi di _col(10)  "P(Mixed | r=1):  " `Eth3obsstar'
 31.         noi di _col(10)  "P(Other | r=1):  " `Eth4obsstar'
 32. 
. end

. 
. 
. 
. 
end of do-file

. 
. 
. 
. ********************************   NOTES  **************************************
. 
. *  Assumes region is string, taking  values: 
. *    East, East Midlands, London, North East, North West, South East, 
. *    South West, West Midlands, and Yorkshire and The Humber
. *
. *  Assumes ethnicity is numeric, taking values: 
. *       1, 2, 3, 4, 5, (missing: . or .u)
. *       in the order White, Black, Asian, Mixed, Other
. *       with value labels exactly as above. 
. *       (NB: this is now intially recoded from ordering: 
. *      White, Mixed, Asian, Black, Other)       
. *
. *
. *  Assumes a complete case sample other than ethnicity
. *
. ********************************************************************************
. 
. 
. 
. 
.                         
. *******************************************************
. *  Perform imputations within each region separately  *
. *******************************************************
. 
. * List of regions
. global region1 = "East"

. global region2 = "East Midlands"        

. global region3 = "London" 

. global region4 = "North East" 

. global region5 = "North West" 

. global region6 = "South East" 

. global region7 = "South West" 

. global region8 = "West Midlands" 

. global region9 = "Yorkshire and The Humber"  

. 
. 
. 
. 
. * Open data 
. use cr_create_analysis_dataset.dta, clear
(Analysis dataset for the poor outcomes in Covid project)

. tab region, m

     Geographical region |      Freq.     Percent        Cum.
-------------------------+-----------------------------------
                         |        696        0.00        0.00
                    East |  4,009,193       23.20       23.21
           East Midlands |  3,042,133       17.61       40.81
                  London |  1,196,048        6.92       47.74
              North East |    805,443        4.66       52.40
              North West |  1,544,670        8.94       61.34
              South East |  1,166,036        6.75       68.09
              South West |  2,343,220       13.56       81.65
           West Midlands |    693,822        4.02       85.66
Yorkshire and The Humber |  2,477,131       14.34      100.00
-------------------------+-----------------------------------
                   Total | 17,278,392      100.00

. 
. 
. * Only keep data from one region
. keep if region=="${region`k'}"
(16,082,344 observations deleted)

. tab region, m   

     Geographical region |      Freq.     Percent        Cum.
-------------------------+-----------------------------------
                  London |  1,196,048      100.00      100.00
-------------------------+-----------------------------------
                   Total |  1,196,048      100.00

.         
. * Change ordering of ethnicity
. label define ethnicity 1 "White" 2 "Black" 3 "Asian" 4 "Mixed" 5 "Other", modify

. recode ethnicity 1=1 2=4 3=3 4=2 5=5
(ethnicity: 120748 changes made)

. 
. 
. * Only keep required variables
. keep patient_id stp region ethnicity                            ///
>         stime_`outcome' `outcome' enter_date                    ///
>         agegroup male obese4cat                                                 ///
>         smoke_nomiss imd htdiag_or_highbp                               ///
>         chronic_respiratory_disease                                     ///
>         asthmacat                                                                               ///
>         chronic_cardiac_disease                                                 ///
>         diabcat                                                                                 ///
>         cancer_exhaem_cat                                                               ///
>         cancer_haem_cat                                                                 ///
>         chronic_liver_disease                                                   ///
>         stroke_dementia                                                                 ///
>         other_neuro                                                                             ///
>         reduced_kidney_function_cat                                             ///
>         organ_transplant                                                                ///
>         spleen                                                                                  ///
>         ra_sle_psoriasis                                                                ///
>         other_immunosuppression

. 
.                 
. * Create complete case sample (except for ethnicity) 
. drop if imd>=. 
(0 observations deleted)

. 
. * Set as survival
. stset stime_`outcome', fail(`outcome') enter(enter_date)        ///
>         origin(enter_date) id(patient_id)

                id:  patient_id
     failure event:  onscoviddeath != 0 & onscoviddeath < .
obs. time interval:  (stime_onscoviddeath[_n-1], stime_onscoviddeath]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
  1,196,048  total observations
         18  observations end on or before enter()
------------------------------------------------------------------------------
  1,196,030  observations remaining, representing
  1,196,030  subjects
        947  failures in single-failure-per-subject data
  113522520  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =        95

. 
. * Generate the Nelson-Aalen estimate of the cumulative hazard
. sts generate cumh = na 

. egen cumhgp = cut(cumh), group(5) 
(18 missing values generated)

. replace cumhgp = cumhgp+1
(1,196,030 real changes made)

. 
. * Gene missingness indicator
. gen r = 1 - missing(ethnicity)

. 
. * Create dummy variables for categorical predictors
. foreach var of varlist agegroup obese4cat smoke_nomiss imd  ///
>         asthmacat diabcat cancer_exhaem_cat cancer_haem_cat     reduced_kidney_function_cat     ///
>         stp cumhgp {
  2.                 egen ord_`var' = group(`var')
  3.                 qui summ ord_`var'
  4.                 local max=r(max)
  5.                 forvalues i = 1 (1) `max' {
  6.                         gen `var'_`i' = (`var'==`i')
  7.                 }       
  8.                 drop ord_`var'
  9.                 drop `var'_1
 10. }
(18 missing values generated)

. 
. 
. 
. forvalues m = 1 (1) 5   {
  2. 
.         /*      Number of patients with missing ethnicity  */
. 
.         count_missing r
  3.         global Nmis = r(Nmis)
  4.         global Nobs = r(Nobs)
  5. 
. 
.         /*  Draw probability of observing ethnicity  */
. 
.         global r0star = r(r0star)
  6.         global r1star = r(r1star)
  7. 
. 
.         /*  Draw probability of each ethnicity category  */ 
. 
.         prop_ethnicity ethnicity
  8.         forvalues j = 1 (1) 4 {
  9.                 global Eth`j'obsstar = r(Eth`j'obsstar)
 10.         }
 11. 
.                 
.                 
.         *******************************************************************
.         *  External parameters needed to estimate calibration parameters  *
.         *******************************************************************
.                 
.         /*      External data distribution of ethnicity         */
. 
.         if `k'==1 {     // East
 12.                 global Eth1 = 0.02252
 13.                 global Eth2 = 0.048303
 14.                 global Eth3 = 0.016971
 15.                 global Eth4 = 0.009791  
 16.         }
 17.         else if `k'==2 {        // East Midlands
 18.                 global Eth1 = 0.019259
 19.                 global Eth2 = 0.062222
 20.                 global Eth3 = 0.012698
 21.                 global Eth4 = 0.008254
 22.         }
 23.         else if `k'==3 {        // London
 24.                 global Eth1 = 0.124872
 25.                 global Eth2 = 0.183715
 26.                 global Eth3 = 0.037176
 27.                 global Eth4 = 0.060554
 28.         }               
 29.         else if `k'==4 {        // North East
 30.                 global Eth1 = 0.006447  
 31.                 global Eth2 = 0.029579
 32.                 global Eth3 = 0.005309
 33.                 global Eth4 = 0.006826
 34.         }       
 35.         else if `k'==5 {        // North West
 36.                 global Eth1 = 0.018688  
 37.                 global Eth2 = 0.06423
 38.                 global Eth3 = 0.012458
 39.                 global Eth4 = 0.011766
 40.         }       
 41.         else if `k'==6 {        // South East
 42.                 global Eth1 = 0.01665
 43.                 global Eth2 = 0.053826
 44.                 global Eth3 = 0.01722
 45.                 global Eth4 = 0.012544
 46.         }       
 47.         else if `k'==7 {        // South West
 48.                 global Eth1 = 0.009425  
 49.                 global Eth2 = 0.021388
 50.                 global Eth3 = 0.010332
 51.                 global Eth4 = 0.008519
 52.         }       
 53.         else if `k'==8 {        // West Midlands
 54.                 global Eth1 = 0.033207  
 55.                 global Eth2 = 0.121129
 56.                 global Eth3 = 0.015657
 57.                 global Eth4 = 0.014109
 58.         }       
 59.         else if `k'==9 {        // Yorkshire and the Humber
 60.                 global Eth1 = 0.015112
 61.                 global Eth2 = 0.066532
 62.                 global Eth3 = 0.014191
 63.                 global Eth4 = 0.011426
 64.         }       
 65.                         
. 
. 
. 
. 
. 
.         ***********************************************************************
.         *  Obtain linear predictor needed to estimate calibration parameters  *
.         ***********************************************************************
. 
. 
.         /*   Fit imputation model for ethnicity   */
. 
.         * 4th region only has one STP so exclude from model
.         if `k'!=4 { 
 66.                 local stp_text = "stp_*"
 67.         }
 68.         else {
 69.                 local stp_text = ""
 70.         }
 71. 
.         * Fit imputation model for ethnicity
.         capture drop temp
 72.         noi uvis mlogit ethnicity                               ///
>                 `stp_text'                                                      ///
>                 cumhgp_* `outcome'                                      ///
>                 agegroup_*                                              ///
>                 male                                                            ///
>                 obese4cat_*                                                     ///
>                 smoke_nomiss_*                                          ///
>                 imd_*                                                           ///
>                 htdiag_or_highbp                                        ///
>                 chronic_respiratory_disease             ///
>                 asthmacat_*                                             ///
>                 chronic_cardiac_disease                         ///
>                 diabcat_*                                                       ///
>                 cancer_exhaem_cat_*                             ///
>                 cancer_haem_cat_*                                       ///
>                 chronic_liver_disease                           ///
>                 stroke_dementia                                         ///
>                 other_neuro                                                     ///
>                 reduced_kidney_function_cat_*           ///
>                 organ_transplant                                        ///
>                 spleen                                                          ///
>                 ra_sle_psoriasis                                        ///
>                 other_immunosuppression,                        ///
>                 gen(temp) baseoutcome(1)
 73.         drop temp
 74.         
.         * Obtain linear predictor, for P(eth=j | r=1)
.         local eth_text_1 = "Black"
 75.         local eth_text_2 = "Asian"
 76.         local eth_text_3 = "Mixed"
 77.         local eth_text_4 = "Other"
 78. 
.         forvalues j = 1 (1) 4 {
 79.                 qui gen lp`j' = [`eth_text_`j'']_b[_cons]
 80.                 foreach var of varlist                                  ///
>                         `stp_text'                                                      ///
>                         cumhgp_* `outcome'                                      ///
>                         agegroup_*                                              ///
>                         male obese4cat_*                                        ///
>                         smoke_nomiss_*                                          ///
>                         imd_*                                                           ///
>                         htdiag_or_highbp                                        ///
>                         chronic_respiratory_disease             ///
>                         asthmacat_*                                             ///
>                         chronic_cardiac_disease                         ///
>                         diabcat_*                                                       ///
>                         cancer_exhaem_cat_*                             ///
>                         cancer_haem_cat_*                                       ///
>                         chronic_liver_disease                           ///
>                         stroke_dementia                                         ///
>                         other_neuro                                                     ///
>                         reduced_kidney_function_cat_*           ///
>                         organ_transplant                                        ///
>                         spleen                                                          ///
>                         ra_sle_psoriasis                                        ///
>                         other_immunosuppression                         ///
>                          {
 81.                          capture  di [`eth_text_`j'']_b[`var'] 
 82.                          if _rc==0 {
 83.                                 qui replace lp`j' = lp`j' + [`eth_text_`j'']_b[`var']*(`var'==1)
 84.                         }
 85.                 }
 86.         }
 87. 
.                 
.         * Create variable to house estimation results
.         noi summ lp?
 88.         nlnle2_wrap
 89.         global gamma1 = r(rr1) 
 90.         global gamma2 = r(rr2) 
 91.         global gamma3 = r(rr3) 
 92.         global gamma4 = r(rr4) 
 93. 
. 
.         noi di "Weight for Black: " $gamma1
 94.         noi di "Weight for Asian: " $gamma2
 95.         noi di "Weight for Mixed: " $gamma3
 96.         noi di "Weight for Other: " $gamma4
 97.         
.         
.         * Delete variables no longer needed
.         drop lp1 lp2 lp3 lp4
 98.         
.         
. 
.         **********************
.         *  Impute ethnicity  *
.         **********************
. 
. 
.         /*  Use calibration parameters to generate probability weights (P(obs))  */
. 
.         * Missing ethnicities, assign a small weight
.         * Observed ethnicities, weight = the RR from above (for non-ref groups)
.         cap drop caldelw
 99.         gen     caldelw = 0.0001 
100.         replace caldelw = 1           if ethnicity == 1
101.         replace caldelw = $gamma1 if ethnicity == 2
102.         replace caldelw = $gamma2 if ethnicity == 3
103.         replace caldelw = $gamma3 if ethnicity == 4
104.         replace caldelw = $gamma4 if ethnicity == 5
105. 
.         noi tab caldelw ethnicity, m
106.         noi di "Manual replacements to avoid crashes:"
107.         replace caldelw = 0.1 if caldelw==0 & ethnicity<. // To avoid crashes
108. 
. 
.         /*  Fit imputation model in weighted population */
.         
.         uvis mlogit ethnicity                                   ///
>                 `stp_text'                                                      ///
>                 cumhgp_* `outcome'                                      ///
>                 agegroup_*                                              ///
>                 male                                                            ///
>                 obese4cat_*                                                     ///
>                 smoke_nomiss_*                                          ///
>                 imd_*                                                           ///
>                 htdiag_or_highbp                                        ///
>                 chronic_respiratory_disease             ///
>                 asthmacat_*                                             ///
>                 chronic_cardiac_disease                         ///
>                 diabcat_*                                                       ///
>                 cancer_exhaem_cat_*                             ///
>                 cancer_haem_cat_*                                       ///
>                 chronic_liver_disease                           ///
>                 stroke_dementia                                         ///
>                 other_neuro                                                     ///
>                 reduced_kidney_function_cat_*           ///
>                 organ_transplant                                        ///
>                 spleen                                                          ///
>                 ra_sle_psoriasis                                        ///
>                 other_immunosuppression                         ///
>                 [pw=caldelw],                                           ///
>                 baseoutcome(1)                                          ///
>                 gen(ethnicity`m') 
109.         drop caldelw
110.         
. }

Observed proportions:
         Number Missing:   186816
         Number Observed:  1009232

Drawn probabilities:
         P(Missing):        .1568668
         P(Observed):       .8431332

Proportion estimation             Number of obs   =  1,009,232

--------------------------------------------------------------
             |                                   Logit
             | Proportion   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
   ethnicity |
      White  |   .5511894   .0004951      .5502189    .5521596
      Black  |   .0858574   .0002789      .0853124    .0864055
      Asian  |   .2411943   .0004258      .2403606    .2420299
      Mixed  |   .0337861   .0001798      .0334354    .0341404
      Other  |   .0879728    .000282      .0874218     .088527
--------------------------------------------------------------

Observed proportions of each ethnic group:
         Proportion Black:   .08585736
         Proportion Asian:   .24119429
         Proportion Mixed:   .03378609
         Proportion Other:   .08797283

Drawn probabilities of each ethnic group:
         P(Black | r=1):  .08614812
         P(Asian | r=1):  .24132107
         P(Mixed | r=1):  .03347636
         P(Other | r=1):  .08776723
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 = 1.050]

186816 missing observations on ethnicity imputed from 1009232 complete observations.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
         lp1 |  1,196,048   -2.003666    .9044359  -6.014094   3.058256
         lp2 |  1,196,048   -.9526723    .9756868  -5.353444   2.616113
         lp3 |  1,196,048   -2.781787    .5059812  -5.790901   .0467618
         lp4 |  1,196,048   -1.812607    .5241899  -4.786909    .025696

INPUTS:

Missingness of ethnicity:
         Number missing ethnicity data:   186816
         Probability of missing  (drawn): .1568668
         Probability of observed (drawn): .8431332

Drawn proportions (among complete cases):
         Black (drawn): .08614812
         Asian (drawn): .24132107
         Mixed (drawn): .03347636
         Other (drawn): .08776723

External data:
         Black (external): .124872
         Asian (external): .183715
         Mixed (external): .037176
         Other (external): .060554

ESTIMATED CALIBRATION PARAMETERS:  
         Parameter (log scale):
         Black:  0
         Asian:  0
         Mixed:  0
         Other:  -2.9145782
         Relative risk (for being this ethnicity (vs white)
              ...in missing cf complete cases):
         Black:  1
         Asian:  1
         Mixed:  1
         Other:  .0542269
Weight for Black: 1
Weight for Asian: 1
Weight for Mixed: 1
Weight for Other: .0542269
(556,278 real changes made)
(86,650 real changes made)
(243,421 real changes made)
(34,098 real changes made)
(88,785 real changes made)

           |                             Ethnicity
   caldelw |     White      Black      Asian      Mixed      Other    Unknown |     Total
-----------+------------------------------------------------------------------+----------
     .0001 |         0          0          0          0          0    186,816 |   186,816 
  .0542269 |         0          0          0          0     88,785          0 |    88,785 
         1 |   556,278     86,650    243,421     34,098          0          0 |   920,447 
-----------+------------------------------------------------------------------+----------
     Total |   556,278     86,650    243,421     34,098     88,785    186,816 | 1,196,048 
Manual replacements to avoid crashes:
(0 real changes made)
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 =  2.5e+06]

186816 missing observations on ethnicity imputed from 1009232 complete observations.

Observed proportions:
         Number Missing:   186816
         Number Observed:  1009232

Drawn probabilities:
         P(Missing):        .15596823
         P(Observed):       .84403177

Proportion estimation             Number of obs   =  1,009,232

--------------------------------------------------------------
             |                                   Logit
             | Proportion   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
   ethnicity |
      White  |   .5511894   .0004951      .5502189    .5521596
      Black  |   .0858574   .0002789      .0853124    .0864055
      Asian  |   .2411943   .0004258      .2403606    .2420299
      Mixed  |   .0337861   .0001798      .0334354    .0341404
      Other  |   .0879728    .000282      .0874218     .088527
--------------------------------------------------------------

Observed proportions of each ethnic group:
         Proportion Black:   .08585736
         Proportion Asian:   .24119429
         Proportion Mixed:   .03378609
         Proportion Other:   .08797283

Drawn probabilities of each ethnic group:
         P(Black | r=1):  .08637569
         P(Asian | r=1):  .24113057
         P(Mixed | r=1):  .03368068
         P(Other | r=1):  .08811792
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 = 1.069]

186816 missing observations on ethnicity imputed from 1009232 complete observations.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
         lp1 |  1,196,048   -2.003666    .9044359  -6.014094   3.058256
         lp2 |  1,196,048   -.9526723    .9756868  -5.353444   2.616113
         lp3 |  1,196,048   -2.781787    .5059812  -5.790901   .0467618
         lp4 |  1,196,048   -1.812607    .5241899  -4.786909    .025696

INPUTS:

Missingness of ethnicity:
         Number missing ethnicity data:   186816
         Probability of missing  (drawn): .15596823
         Probability of observed (drawn): .84403177

Drawn proportions (among complete cases):
         Black (drawn): .08637569
         Asian (drawn): .24113057
         Mixed (drawn): .03368068
         Other (drawn): .08811792

External data:
         Black (external): .124872
         Asian (external): .183715
         Mixed (external): .037176
         Other (external): .060554

ESTIMATED CALIBRATION PARAMETERS:  
         Parameter (log scale):
         Black:  0
         Asian:  0
         Mixed:  0
         Other:  -123.26077
         Relative risk (for being this ethnicity (vs white)
              ...in missing cf complete cases):
         Black:  1
         Asian:  1
         Mixed:  1
         Other:  2.941e-54
Weight for Black: 1
Weight for Asian: 1
Weight for Mixed: 1
Weight for Other: 2.941e-54
(556,278 real changes made)
(86,650 real changes made)
(243,421 real changes made)
(34,098 real changes made)
(88,785 real changes made)

           |                             Ethnicity
   caldelw |     White      Black      Asian      Mixed      Other    Unknown |     Total
-----------+------------------------------------------------------------------+----------
         0 |         0          0          0          0     88,785          0 |    88,785 
     .0001 |         0          0          0          0          0    186,816 |   186,816 
         1 |   556,278     86,650    243,421     34,098          0          0 |   920,447 
-----------+------------------------------------------------------------------+----------
     Total |   556,278     86,650    243,421     34,098     88,785    186,816 | 1,196,048 
Manual replacements to avoid crashes:
(88,785 real changes made)
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 =  2.0e+09]

186816 missing observations on ethnicity imputed from 1009232 complete observations.

Observed proportions:
         Number Missing:   186816
         Number Observed:  1009232

Drawn probabilities:
         P(Missing):        .15624828
         P(Observed):       .84375172

Proportion estimation             Number of obs   =  1,009,232

--------------------------------------------------------------
             |                                   Logit
             | Proportion   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
   ethnicity |
      White  |   .5511894   .0004951      .5502189    .5521596
      Black  |   .0858574   .0002789      .0853124    .0864055
      Asian  |   .2411943   .0004258      .2403606    .2420299
      Mixed  |   .0337861   .0001798      .0334354    .0341404
      Other  |   .0879728    .000282      .0874218     .088527
--------------------------------------------------------------

Observed proportions of each ethnic group:
         Proportion Black:   .08585736
         Proportion Asian:   .24119429
         Proportion Mixed:   .03378609
         Proportion Other:   .08797283

Drawn probabilities of each ethnic group:
         P(Black | r=1):  .08654901
         P(Asian | r=1):  .24102203
         P(Mixed | r=1):  .03351504
         P(Other | r=1):  .08791161
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 = 0.584]

186816 missing observations on ethnicity imputed from 1009232 complete observations.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
         lp1 |  1,196,048   -2.003666    .9044359  -6.014094   3.058256
         lp2 |  1,196,048   -.9526723    .9756868  -5.353444   2.616113
         lp3 |  1,196,048   -2.781787    .5059812  -5.790901   .0467618
         lp4 |  1,196,048   -1.812607    .5241899  -4.786909    .025696

INPUTS:

Missingness of ethnicity:
         Number missing ethnicity data:   186816
         Probability of missing  (drawn): .15624828
         Probability of observed (drawn): .84375172

Drawn proportions (among complete cases):
         Black (drawn): .08654901
         Asian (drawn): .24102203
         Mixed (drawn): .03351504
         Other (drawn): .08791161

External data:
         Black (external): .124872
         Asian (external): .183715
         Mixed (external): .037176
         Other (external): .060554

ESTIMATED CALIBRATION PARAMETERS:  
         Parameter (log scale):
         Black:  0
         Asian:  0
         Mixed:  0
         Other:  -158291.73
         Relative risk (for being this ethnicity (vs white)
              ...in missing cf complete cases):
         Black:  1
         Asian:  1
         Mixed:  1
         Other:  0
Weight for Black: 1
Weight for Asian: 1
Weight for Mixed: 1
Weight for Other: 0
(556,278 real changes made)
(86,650 real changes made)
(243,421 real changes made)
(34,098 real changes made)
(88,785 real changes made)

           |                             Ethnicity
   caldelw |     White      Black      Asian      Mixed      Other    Unknown |     Total
-----------+------------------------------------------------------------------+----------
         0 |         0          0          0          0     88,785          0 |    88,785 
     .0001 |         0          0          0          0          0    186,816 |   186,816 
         1 |   556,278     86,650    243,421     34,098          0          0 |   920,447 
-----------+------------------------------------------------------------------+----------
     Total |   556,278     86,650    243,421     34,098     88,785    186,816 | 1,196,048 
Manual replacements to avoid crashes:
(88,785 real changes made)
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 =  7.6e+11]

186816 missing observations on ethnicity imputed from 1009232 complete observations.

Observed proportions:
         Number Missing:   186816
         Number Observed:  1009232

Drawn probabilities:
         P(Missing):        .1563726
         P(Observed):       .8436274

Proportion estimation             Number of obs   =  1,009,232

--------------------------------------------------------------
             |                                   Logit
             | Proportion   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
   ethnicity |
      White  |   .5511894   .0004951      .5502189    .5521596
      Black  |   .0858574   .0002789      .0853124    .0864055
      Asian  |   .2411943   .0004258      .2403606    .2420299
      Mixed  |   .0337861   .0001798      .0334354    .0341404
      Other  |   .0879728    .000282      .0874218     .088527
--------------------------------------------------------------

Observed proportions of each ethnic group:
         Proportion Black:   .08585736
         Proportion Asian:   .24119429
         Proportion Mixed:   .03378609
         Proportion Other:   .08797283

Drawn probabilities of each ethnic group:
         P(Black | r=1):  .08539264
         P(Asian | r=1):  .2408163
         P(Mixed | r=1):  .03385273
         P(Other | r=1):  .08823432
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 = 0.925]

186816 missing observations on ethnicity imputed from 1009232 complete observations.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
         lp1 |  1,196,048   -2.003666    .9044359  -6.014094   3.058256
         lp2 |  1,196,048   -.9526723    .9756868  -5.353444   2.616113
         lp3 |  1,196,048   -2.781787    .5059812  -5.790901   .0467618
         lp4 |  1,196,048   -1.812607    .5241899  -4.786909    .025696

INPUTS:

Missingness of ethnicity:
         Number missing ethnicity data:   186816
         Probability of missing  (drawn): .1563726
         Probability of observed (drawn): .8436274

Drawn proportions (among complete cases):
         Black (drawn): .08539264
         Asian (drawn): .2408163
         Mixed (drawn): .03385273
         Other (drawn): .08823432

External data:
         Black (external): .124872
         Asian (external): .183715
         Mixed (external): .037176
         Other (external): .060554

ESTIMATED CALIBRATION PARAMETERS:  
         Parameter (log scale):
         Black:  0
         Asian:  0
         Mixed:  0
         Other:  -733.33343
         Relative risk (for being this ethnicity (vs white)
              ...in missing cf complete cases):
         Black:  1
         Asian:  1
         Mixed:  1
         Other:  0
Weight for Black: 1
Weight for Asian: 1
Weight for Mixed: 1
Weight for Other: 0
(556,278 real changes made)
(86,650 real changes made)
(243,421 real changes made)
(34,098 real changes made)
(88,785 real changes made)

           |                             Ethnicity
   caldelw |     White      Black      Asian      Mixed      Other    Unknown |     Total
-----------+------------------------------------------------------------------+----------
         0 |         0          0          0          0     88,785          0 |    88,785 
     .0001 |         0          0          0          0          0    186,816 |   186,816 
         1 |   556,278     86,650    243,421     34,098          0          0 |   920,447 
-----------+------------------------------------------------------------------+----------
     Total |   556,278     86,650    243,421     34,098     88,785    186,816 | 1,196,048 
Manual replacements to avoid crashes:
(88,785 real changes made)
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 =  1.4e+10]

186816 missing observations on ethnicity imputed from 1009232 complete observations.

Observed proportions:
         Number Missing:   186816
         Number Observed:  1009232

Drawn probabilities:
         P(Missing):        .15612032
         P(Observed):       .84387968

Proportion estimation             Number of obs   =  1,009,232

--------------------------------------------------------------
             |                                   Logit
             | Proportion   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
   ethnicity |
      White  |   .5511894   .0004951      .5502189    .5521596
      Black  |   .0858574   .0002789      .0853124    .0864055
      Asian  |   .2411943   .0004258      .2403606    .2420299
      Mixed  |   .0337861   .0001798      .0334354    .0341404
      Other  |   .0879728    .000282      .0874218     .088527
--------------------------------------------------------------

Observed proportions of each ethnic group:
         Proportion Black:   .08585736
         Proportion Asian:   .24119429
         Proportion Mixed:   .03378609
         Proportion Other:   .08797283

Drawn probabilities of each ethnic group:
         P(Black | r=1):  .08550467
         P(Asian | r=1):  .24146253
         P(Mixed | r=1):  .03402994
         P(Other | r=1):  .08797591
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 = 1.029]

186816 missing observations on ethnicity imputed from 1009232 complete observations.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
         lp1 |  1,196,048   -2.003666    .9044359  -6.014094   3.058256
         lp2 |  1,196,048   -.9526723    .9756868  -5.353444   2.616113
         lp3 |  1,196,048   -2.781787    .5059812  -5.790901   .0467618
         lp4 |  1,196,048   -1.812607    .5241899  -4.786909    .025696

INPUTS:

Missingness of ethnicity:
         Number missing ethnicity data:   186816
         Probability of missing  (drawn): .15612032
         Probability of observed (drawn): .84387968

Drawn proportions (among complete cases):
         Black (drawn): .08550467
         Asian (drawn): .24146253
         Mixed (drawn): .03402994
         Other (drawn): .08797591

External data:
         Black (external): .124872
         Asian (external): .183715
         Mixed (external): .037176
         Other (external): .060554

ESTIMATED CALIBRATION PARAMETERS:  
         Parameter (log scale):
         Black:  0
         Asian:  -22857.782
         Mixed:  0
         Other:  -176.51807
         Relative risk (for being this ethnicity (vs white)
              ...in missing cf complete cases):
         Black:  1
         Asian:  0
         Mixed:  1
         Other:  2.184e-77
Weight for Black: 1
Weight for Asian: 0
Weight for Mixed: 1
Weight for Other: 2.184e-77
(556,278 real changes made)
(86,650 real changes made)
(243,421 real changes made)
(34,098 real changes made)
(88,785 real changes made)

           |                             Ethnicity
   caldelw |     White      Black      Asian      Mixed      Other    Unknown |     Total
-----------+------------------------------------------------------------------+----------
         0 |         0          0    243,421          0     88,785          0 |   332,206 
     .0001 |         0          0          0          0          0    186,816 |   186,816 
         1 |   556,278     86,650          0     34,098          0          0 |   677,026 
-----------+------------------------------------------------------------------+----------
     Total |   556,278     86,650    243,421     34,098     88,785    186,816 | 1,196,048 
Manual replacements to avoid crashes:
(332,206 real changes made)
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 =  1.3e+15]

186816 missing observations on ethnicity imputed from 1009232 complete observations.

. 
. * Keep the imputed data and patient ID for each region
. keep patient_id region ethnicity*

. 
. * Save the data
. save imputed_`outcome'_`k', replace
(note: file imputed_onscoviddeath_3.dta not found)
file imputed_onscoviddeath_3.dta saved

. 
. 
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-risk-factors-research-full\analysis\output/an_checkassumptions_MI_onscoviddeath_3.log
  log type:  text
 closed on:   7 Jul 2020, 03:24:15
----------------------------------------------------------------------------------------------------------------------------------
